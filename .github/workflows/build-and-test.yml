name: Build & test plugin

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read
  pull-requests: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Setup enviroment
        uses: scipion-chem/.github/.github/composites/install-scipion@main

      - name: Clone scipion-chem
        uses: scipion-chem/.github/.github/composites/clone-in-branch@main
        with:
          path: ${{ github.workspace }}/../
          repo_url: https://github.com/scipion-chem/scipion-chem
          prioritized_branches: "${{ github.head_ref || github.ref_name }},${{ github.base_ref || 'main' }}"

      - name: Install scipion-chem
        working-directory: ${{ github.workspace }}/../
        run: scipion/scipion3 installp -p scipion-chem/ --devel

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Install plugin
        working-directory: ${{ github.workspace }}
        run: ../scipion/scipion3 installp -p . --devel

      - name: Run tests
        working-directory: ${{ github.workspace }}/${{ vars.FOLDER_WITH_VERSION }}
        run: |
          pip install --user scipion-testrunner
          scipion_testrunner ${{ github.workspace }}/../scipion/scipion3 ${{ vars.FOLDER_WITH_VERSION }} --noGpu --testData=testData.json